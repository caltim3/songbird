<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SongBird - Smart Songwriting Assistant</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1e1e2f;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    main {
      padding: 2rem;
      max-width: 960px;
      margin: auto;
    }
    select, button, textarea, input[type=number] {
      font-size: 1rem;
      padding: 0.5rem;
      margin: 0.5rem 0;
      width: 100%;
    }
    .chord-progression {
      margin: 1rem 0;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .suggestion-box {
      margin-top: 1rem;
      font-style: italic;
      color: #666;
    }
    #keyboard {
      display: flex;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    .key {
      width: 40px;
      height: 120px;
      margin: 1px;
      background: #fff;
      border: 1px solid #000;
      box-sizing: border-box;
      text-align: center;
      line-height: 120px;
      font-size: 0.75rem;
      user-select: none;
    }
    .key.sharp {
      background: #000;
      color: #fff;
      width: 30px;
      height: 80px;
      margin-left: -15px;
      margin-right: -15px;
      z-index: 2;
      position: relative;
    }
    .key.playing {
      background: yellow !important;
      color: black !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>SongBird</h1>
    <p>Smart songwriting assistant with musical theory tools</p>
  </header>
  <main>
    <label for="key">Choose Key:</label>
    <select id="key">
      <option>C</option><option>C#</option><option>D</option><option>Eb</option>
      <option>E</option><option>F</option><option>F#</option><option>G</option>
      <option>Ab</option><option>A</option><option>Bb</option><option>B</option>
    </select>

    <label for="genre">Choose Genre:</label>
    <select id="genre">
      <option>Pop</option><option>Rock</option><option>Country</option>
      <option>Jazz - Bebop</option><option>Jazz - Ballad</option>
      <option>Jazz - Hard Bop</option><option>Jazz - Gypsy</option>
      <option>Jazz - Modal</option>
    </select>

    <button onclick="suggestNextChord()">Suggest Next Chord</button>

    <div class="chord-progression">
      <h3>Current Progression:</h3>
      <p id="progression-display">(empty)</p>
      <div class="suggestion-box" id="suggestion-box"></div>
    </div>

    <label for="customChord">Add/Modify Chord:</label>
    <textarea id="customChord" placeholder="Enter custom chord(s), e.g. Am7 D7 Gmaj7"></textarea>
    <button onclick="addCustomChords()">Update Progression</button>

    <div style="margin-top: 1rem;">
      <button onclick="addNewBar()">+ Add New Bar</button>
      <button onclick="insertSection()">+ Add Section Label</button>
      <button onclick="playProgression()">â–¶ Play Progression</button>
    </div>

    <div style="margin-top: 1rem;">
      <label for="bpm">Tempo (BPM):</label>
      <input type="number" id="bpm" value="90" min="30" max="300" style="width: 80px;">
    </div>

    <h3>Lead Sheet</h3>
    <div id="leadSheetGridContainer"></div>

    <h3>Virtual Piano</h3>
    <div id="keyboard"></div>
  </main>

  <script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const SAMPLE_PATH = '/samples/';
    const loadedSamples = {};
    const progressions = [];
    let playbackIndex = -1;

    const chordVoicings = {
      'C': ['c3', 'e3', 'g3'], 'Cm': ['c3', 'ds3', 'g3'],
      'D': ['d3', 'fs3', 'a3'], 'Dm': ['d3', 'f3', 'a3'],
      'E': ['e3', 'gs3', 'b3'], 'F': ['f3', 'a3', 'c4'],
      'Fm': ['f3', 'gs3', 'c4'], 'G': ['g2', 'b2', 'd3'],
      'G7': ['g2', 'b2', 'd3', 'f3'], 'Am': ['a2', 'c3', 'e3'],
      'A7': ['a2', 'cs3', 'e3', 'g3'], 'Bdim': ['b2', 'd3', 'f3'],
      'Cmaj7': ['c3', 'e3', 'g3', 'b3'], 'Fmaj7': ['f3', 'a3', 'c4', 'e4'],
      'D7': ['d3', 'fs3', 'a3', 'c4']
    };

    function chordToNotes(chordName) {
      return chordVoicings[chordName];
    }

    function noteToFilename(note) {
      return note.toLowerCase().replace('#', 's') + '.wav';
    }

    async function loadSample(note) {
      const filename = noteToFilename(note);
      if (loadedSamples[filename]) return loadedSamples[filename];
      try {
        const response = await fetch(SAMPLE_PATH + filename);
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        loadedSamples[filename] = audioBuffer;
        return audioBuffer;
      } catch (e) {
        console.warn(`Missing sample for ${note}`);
        return null;
      }
    }

    async function playNote(note) {
      const buffer = await loadSample(note);
      if (!buffer) return;
      highlightKey(note);
      const source = audioContext.createBufferSource();
      const gain = audioContext.createGain();
      gain.gain.value = 0.8;
      source.buffer = buffer;
      source.connect(gain).connect(audioContext.destination);
      source.start();
    }

    async function playChord(chordName) {
      const notes = chordToNotes(chordName);
      if (!notes) return;
      for (const note of notes) playNote(note);
    }

    function playProgression() {
      const bpm = parseInt(document.getElementById('bpm').value);
      const delay = Math.round((60 / bpm) * 1000);
      let i = 0;
      function next() {
        while (i < progressions.length && progressions[i].startsWith('[')) {
          i++;
        }
        if (i < progressions.length) {
          playbackIndex = i;
          updateLeadSheetGrid();
          playChord(progressions[i]);
          i++;
          setTimeout(next, delay);
        } else {
          playbackIndex = -1;
          updateLeadSheetGrid();
        }
      }
      next();
    }

    function addNewBar() {
      const chord = prompt("Enter new chord:");
      if (chord) {
        progressions.push(chord);
        updateProgressionDisplay();
      }
    }

    function insertSection() {
      const section = prompt("Enter section name:");
      if (section) {
        progressions.push(`[${section}]`);
        updateProgressionDisplay();
      }
    }

    function suggestNextChord() {
      const chord = prompt("Suggest a chord manually for now (until AI logic added):");
      if (chord) {
        progressions.push(chord);
        updateProgressionDisplay();
      }
    }

    function addCustomChords() {
      const input = document.getElementById('customChord').value;
      if (input) {
        progressions.push(...input.trim().split(/\s+/));
        document.getElementById('customChord').value = '';
        updateProgressionDisplay();
      }
    }

    function updateProgressionDisplay() {
      document.getElementById('progression-display').innerText = progressions.join(' | ');
      updateLeadSheetGrid();
    }

    function updateLeadSheetGrid() {
      const container = document.getElementById('leadSheetGridContainer');
      container.innerHTML = '';
      const barsPerLine = 4;
      let row;
      let barIndex = 0;

      progressions.forEach((item, index) => {
        if (item.startsWith('[')) {
          const sectionLabel = document.createElement('div');
          sectionLabel.textContent = item.replace(/\[|\]/g, '');
          sectionLabel.style.fontWeight = 'bold';
          sectionLabel.style.fontSize = '1.2rem';
          sectionLabel.style.marginTop = '1rem';
          container.appendChild(sectionLabel);
          return;
        }

        if (barIndex % barsPerLine === 0) {
          row = document.createElement('div');
          row.style.display = 'grid';
          row.style.gridTemplateColumns = `repeat(${barsPerLine}, 1fr)`;
          row.style.gap = '8px';
          row.style.marginBottom = '0.5rem';
          container.appendChild(row);
        }

        const cell = document.createElement('div');
        cell.textContent = `${barIndex + 1}. ${item}`;
        cell.setAttribute('draggable', true);
        cell.style.padding = '1rem';
        cell.style.border = '1px solid #ccc';
        cell.style.borderRadius = '6px';
        cell.style.textAlign = 'center';
        cell.style.background = (index === playbackIndex) ? '#ffeaa7' : '#fff';
        cell.style.fontWeight = 'bold';
        cell.style.fontSize = '1rem';
        cell.style.cursor = 'pointer';

        cell.onclick = () => {
          const newChord = prompt(`Edit chord for bar ${barIndex + 1}`, item);
          if (newChord) {
            progressions[index] = newChord;
            updateProgressionDisplay();
          }
        };

        cell.ondragstart = (e) => e.dataTransfer.setData('text/plain', index);
        cell.ondragover = (e) => e.preventDefault();
        cell.ondrop = (e) => {
          e.preventDefault();
          const from = parseInt(e.dataTransfer.getData('text/plain'));
          const temp = progressions[from];
          progressions[from] = progressions[index];
          progressions[index] = temp;
          updateProgressionDisplay();
        };

        row.appendChild(cell);
        barIndex++;
      });
    }

    function createKeyboard() {
      const container = document.getElementById('keyboard');
      const notes = ["c", "cs", "d", "ds", "e", "f", "fs", "g", "gs", "a", "as", "b"];
      for (let octave = 2; octave <= 5; octave++) {
        notes.forEach(note => {
          const key = document.createElement('div');
          key.className = 'key' + (note.includes('s') ? ' sharp' : '');
          key.dataset.note = note + octave;
          key.textContent = note.toUpperCase() + octave;
          key.onclick = () => playNote(note + octave);
          container.appendChild(key);
        });
      }
    }

    function highlightKey(note, duration = 300) {
      const el = document.querySelector(`.key[data-note="${note}"]`);
      if (el) {
        el.classList.add('playing');
        setTimeout(() => el.classList.remove('playing'), duration);
      }
    }

    window.onload = createKeyboard;
  </script>
</body>
</html>
